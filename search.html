<!DOCTYPE html>
<html>

	<head>
		<title>Jones DVD Search</title>
		<link rel="stylesheet" type="text/css" href="resources/css/bootstrap-custom.css" />

		<script type="text/javascript" src="libraries/jquery/js/jquery-1.11.2.min.js"></script>
		<script type="text/javascript" src="resources/js/DisplaySearch.js"></script>

		<!-- Javascript that makes a axaj call to search.php and then takes that information and displays it on this page -->
		<script type="text/javascript">

			$(document).ready(function(){
				var genre = getParam('genre');
				var search_term = getParam('search');

				$('.loading').hide();
				$('.last-updated').hide(); // Hiding a tag added in by omni update.
				$('#search-results-wrapper').hide();

				$('#header').load('header.html', function(){
					if (search_term){
						$('.search-field').attr("value", search_term);
					}
				});

				// Specific visual changes for genre and search.
				if (genre){
					$('#display-search-term').hide();
					// If the genre is set to 'none' change the title to say "Pick a genre" and return.
					if (genre == 'none'){
						$("#genre-title").html("Choose a Genre...");
						return;
					}

					// Make the genre selected yellow.
					($("a:contains('" + genre + "')").parent()).attr("class", "active");
					$("#genre-title").html("Genre: " + genre);
				} else if (search_term) {
					$('#search-term > i').html(search_term);
					$('.nav-genre').hide();
				} //TODO: else display error and return.

				$.ajax({ 	url: "resources/php/search.php",
									data: { search: search_term, genre: genre },
									beforeSend: displayLoadingGif,
									success: function(response) {
														$('#search-results-wrapper').fadeIn(200);
														$.each(response.bib_numbers, function(k, v){
															$.ajax({	url: "resources/php/MovieRecord.php",
																				data: { bibnum: v },
																				success: displayResult,
																				dataType: "json",
																				error: errorToConsole	});
														});
														$('.loading').fadeOut(200);
													},
									dataType: "json",
									error: errorToConsole	});

			});

			function errorToConsole(jqXHR, error, exception){
				console.log("Error: " + error + "\njqXHR: " + jqXHR + "\nException: " + exception);
			}

			function displayLoadingGif(){
				$('.loading').html('<img class="center-block" src="resources/images/Loader.gif">');
				$('.loading').fadeIn(400);
			}

			// $(document).ajaxStop(function(){
			// 	$('.loading').fadeOut(700, function(){
			// 		$('#search-results-wrapper').fadeIn(700);
			// 	});
			// });

			function getParam(param){
				var params = window.location.search.substring(1).split('&');

				for(var i = 0; i < params.length; i++){
					var sp = params[i].split('=', 2);
					if (sp[0] === param){
						return decodeURIComponent(sp[1].replace(/\+/g, " "));
					}
				}

				return '';
			}

		</script>
	</head>

	<body>

		<div id="header"></div>

		<h2 class="text-center" id="genre-title"></h2>
		<ul class="nav nav-pills nav-genre">
			<li><a href="search.html?genre=adventure">adventure</a></li>
			<li><a href="search.html?genre=animation">animation</a></li>
			<li><a href="search.html?genre=children">children's</a></li>
			<li><a href="search.html?genre=comedy">comedy</a></li>
			<li><a href="search.html?genre=crime">crime</a></li>
			<li><a href="search.html?genre=documentary">documentary</a></li>
			<li><a href="search.html?genre=drama">drama</a></li>
			<li><a href="search.html?genre=historical">historical</a></li>
			<li><a href="search.html?genre=horror">horror</a></li>
			<li><a href="search.html?genre=romance">romance</a></li>
			<li><a href="search.html?genre=science+fiction">science fiction</a></li>
			<li><a href="search.html?genre=television+programs">television programs</a></li>
			<li><a href="search.html?genre=war">war</a></li>
			<li><a href="search.html?genre=western">western</a></li>
		</ul>

		<div class="container">
			<h3 id="display-search-term">
				Search results for:&nbsp;<span id="search-term"><i></i></span>
			</h3>

			<!-- Where search results will be displayed -->
			<div id="search-results-wrapper">
				<div id="search-results">
					<!-- Need some kind of loading message -->
				</div>
			</div>
		</div>

		<!-- Loading Image. Only shown when axaj call has been made and hasn't returned. -->
		<div class="loading"></div>

	</body>

</html>
